<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Deepscatter V2</title>
    <link rel="stylesheet" href="styles.css">
  </head>
  <body>
    <div id="app-container">
      <div id="side-panel">
        <div id="side-panel-header" style="border-bottom: 1px solid #000;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
            <h2 style="margin: 0; font-size: 1.25rem; font-weight: 600;">Brush</h2>
            <button id="panel-collapse-btn" class="icon-btn" title="Close Panel">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </button>
          </div>
          <div class="header-divider"></div>
          <div id="side-nav-row">
            <div style="display: flex; gap: 0.5rem;">
              <button id="theme-toggle" class="nav-btn" title="Toggle Theme">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                </svg>
              </button>
              <button id="import-csv-button" class="nav-btn" title="Import Data">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="12" y1="5" x2="12" y2="19"></line>
                  <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
              </button>
            </div>
            <div style="display: flex; gap: 0.5rem;">
              <button id="color-nav-btn" class="nav-btn" title="Color By">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"></circle>
                  <path d="M12 2a10 10 0 0 1 0 20"></path>
                </svg>
              </button>
              <button id="filter-nav-btn" class="nav-btn" title="Filter">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
                </svg>
              </button>
            </div>
          </div>
        </div>
        
        <div id="side-panel-content">
          <!-- Tooltip/Point Data Panel (Default) -->
          <div id="panel-tooltips" class="panel-view active">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
              <h3 style="margin: 0;">Tooltip</h3>
              <div style="display: flex; gap: 0.5rem;">
                <button id="select-mode-toggle" class="nav-btn" title="Toggle Selection Mode">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                    <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                    <line x1="12" y1="22.08" x2="12" y2="12"></line>
                  </svg>
                </button>
              </div>
            </div>
            <div id="point-data"></div>
          </div>

          <!-- Color By Panel -->
          <div id="panel-color" class="panel-view hidden">
            <div class="panel-header">
              <button class="back-button" data-target="panel-tooltips">&larr;</button>
              <h3>Color By</h3>
            </div>
            <div class="panel-body">
              <label for="color-by-selector">Select Column:</label>
              <select id="color-by-selector"></select>
              <div id="legend-container"></div>
            </div>
          </div>

          <!-- Filter By Panel -->
          <div id="panel-filter" class="panel-view hidden">
            <div class="panel-header">
              <button class="back-button" data-target="panel-tooltips">&larr;</button>
              <h3>Filter By</h3>
            </div>
            <div class="panel-body">
              <label for="filter-by-selector">Select Column:</label>
              <select id="filter-by-selector"></select>
              <div id="filter-controls"></div>
            </div>
          </div>

          <!-- Select Region Panel -->
          <div id="panel-select" class="panel-view hidden">
            <div class="panel-header">
              <button class="back-button" data-target="panel-tooltips">&larr;</button>
              <h3>Select Region</h3>
            </div>
            <div class="panel-body">
              <p style="color: #666; font-size: 0.9rem;">Coming soon...</p>
            </div>
          </div>
        </div>
        
        <input type="file" id="csv-upload" accept=".csv,.tsv,.json" style="display: none;">
        <div id="resize-handle"></div>
      </div>
      
      <div id="container">
        <div id="selection-rectangle"></div>
        <!-- Hamburger button for expanding collapsed panel -->
        <button id="panel-expand-btn" class="floating-btn hamburger-btn" title="Open Panel" style="display: none;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="3" y1="12" x2="21" y2="12"></line>
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <line x1="3" y1="18" x2="21" y2="18"></line>
          </svg>
        </button>
      </div>
    </div>

    <!-- Bottom Action Panel for Region Selection -->
    <div id="action-panel" class="bottom-action-panel">
      <div class="panel-resize-handle"></div>
      <div class="bottom-panel-header">
        <div class="panel-header-left">
          <h2>Region Selection</h2>
          <div class="selection-info">
            <span id="selection-count">0</span> points selected
          </div>
        </div>
        <div class="panel-header-right">
          <button class="panel-collapse-button" title="Collapse">âˆ’</button>
          <span class="panel-close-button" title="Close">&times;</span>
        </div>
      </div>

      <div class="bottom-panel-body">
        <div class="chart-section">
          <div class="chart-controls">
            <select id="column-selector" class="chart-select"></select>
            <select id="action-selector" class="chart-select">
              <option value="chart">Chart</option>
              <option value="export">Export CSV</option>
            </select>
            <button id="execute-button" class="primary-button">Execute</button>
          </div>
        </div>

        <div id="chart-container"></div>
      </div>
    </div>
    <script>
      console.log('Index HTML executing inline script');
      window.addEventListener('error', function(event) {
        console.error('Global error caught:', event.message, event.error);
      });
      window.addEventListener('unhandledrejection', function(event) {
        console.error('Unhandled rejection:', event.reason);
      });
    </script>
    <script type="module" src="./main.ts"></script>
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const themeToggle = document.getElementById('theme-toggle');
        const appContainer = document.getElementById('app-container');
        
        // Update theme toggle visual state
        const updateThemeToggleState = () => {
          if (appContainer.classList.contains('dark-mode')) {
            themeToggle.classList.add('active');
          } else {
            themeToggle.classList.remove('active');
          }
        };
        
        themeToggle.addEventListener('click', () => {
          document.body.classList.toggle('dark-mode');
          appContainer.classList.toggle('dark-mode');
          updateThemeToggleState();
        });
        
        // Initialize theme toggle state
        updateThemeToggleState();

        const importModal = document.getElementById('import-modal');
        const importCsvButton = document.getElementById('import-csv-button');
        const csvUpload = document.getElementById('csv-upload');
        const closeModal = document.querySelector('.close-button');

        let parsedData = null;
        let headers = [];

        importCsvButton.addEventListener('click', () => csvUpload.click());
        if (closeModal) {
          closeModal.addEventListener('click', () => importModal.style.display = 'none');
        }
        window.addEventListener('click', (event) => {
          if (event.target == importModal) {
            importModal.style.display = 'none';
          }
        });

        // Setup panel navigation
        const setupNav = () => {
          const openPanel = (panelId) => {
            document.querySelectorAll('.panel-view').forEach(p => {
              p.classList.add('hidden');
              p.classList.remove('active');
            });
            const panel = document.getElementById(panelId);
            if (panel) {
              panel.classList.remove('hidden');
              panel.classList.add('active');
            }
            
            // Update nav button states (but preserve select-mode-toggle and theme-toggle state)
            const selectModeToggle = document.getElementById('select-mode-toggle');
            const selectModeActive = selectModeToggle?.classList.contains('active');
            const themeToggle = document.getElementById('theme-toggle');
            const themeActive = themeToggle?.classList.contains('active');
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
              if (btn.id !== 'select-mode-toggle' && btn.id !== 'theme-toggle') {
                btn.classList.remove('active');
              }
            });
            
            // Restore select mode state if it was active
            if (selectModeActive && selectModeToggle) {
              selectModeToggle.classList.add('active');
            }
            // Restore theme toggle state if it was active
            if (themeActive && themeToggle) {
              themeToggle.classList.add('active');
            }
          };

          const colorNavBtn = document.getElementById('color-nav-btn');
          const filterNavBtn = document.getElementById('filter-nav-btn');
          
          colorNavBtn.addEventListener('click', () => {
            // Toggle: if already active, go back to tooltips
            if (colorNavBtn.classList.contains('active')) {
              openPanel('panel-tooltips');
            } else {
              openPanel('panel-color');
              colorNavBtn.classList.add('active');
            }
          });
          
          filterNavBtn.addEventListener('click', () => {
            // Toggle: if already active, go back to tooltips
            if (filterNavBtn.classList.contains('active')) {
              openPanel('panel-tooltips');
            } else {
              openPanel('panel-filter');
              filterNavBtn.classList.add('active');
            }
          });
          
          document.querySelectorAll('.back-button').forEach(btn => {
            btn.addEventListener('click', (e) => {
              const targetId = e.currentTarget.getAttribute('data-target');
              openPanel(targetId);
            });
          });
        };
        setupNav();

        // Setup panel collapse/expand - will be initialized after plot is ready
        const sidePanel = document.getElementById('side-panel');
        const collapseBtn = document.getElementById('panel-collapse-btn');
        const expandBtn = document.getElementById('panel-expand-btn');
        
        const triggerResize = () => {
          // Force multiple resize events to ensure canvas updates
          setTimeout(() => window.dispatchEvent(new Event('resize')), 0);
          setTimeout(() => window.dispatchEvent(new Event('resize')), 100);
          setTimeout(() => window.dispatchEvent(new Event('resize')), 200);
        };
        
        collapseBtn.addEventListener('click', () => {
          sidePanel.style.width = '0px';
          sidePanel.style.minWidth = '0px';
          sidePanel.style.borderRight = 'none';
          sidePanel.style.padding = '0';
          sidePanel.style.overflow = 'hidden';
          expandBtn.style.display = 'flex';
          triggerResize();
        });
        
        expandBtn.addEventListener('click', () => {
          sidePanel.style.width = '350px';
          sidePanel.style.minWidth = '350px';
          sidePanel.style.borderRight = '1px solid #ccc';
          sidePanel.style.padding = '';
          sidePanel.style.overflow = '';
          expandBtn.style.display = 'none';
          triggerResize();
        });

        // Setup resizable side panel
        const resizeHandle = document.getElementById('resize-handle');
        let isResizing = false;
        let startX = 0;
        let startWidth = 0;

        resizeHandle.addEventListener('mousedown', (e) => {
          isResizing = true;
          startX = e.clientX;
          startWidth = sidePanel.offsetWidth;
          e.preventDefault();
          document.body.style.cursor = 'ew-resize';
          document.body.style.userSelect = 'none';
        });

        document.addEventListener('mousemove', (e) => {
          if (!isResizing) return;
          const deltaX = e.clientX - startX;
          const newWidth = Math.max(200, Math.min(800, startWidth + deltaX));
          sidePanel.style.width = newWidth + 'px';
          sidePanel.style.minWidth = newWidth + 'px';
        });

        document.addEventListener('mouseup', () => {
          if (isResizing) {
            isResizing = false;
            document.body.style.cursor = '';
            document.body.style.userSelect = '';
            window.dispatchEvent(new Event('resize'));
          }
        });

        csvUpload.addEventListener('change', (event) => {
          const file = event.target.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = (e) => {
            const text = e.target.result;
            
            function parseCsv(csvText) {
              const lines = csvText.trim().split('\n');
              const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
              const data = [];
              const regex = /(?:^|,)(\"(?:[^\"]+|\"\")*\"|[^,]*)/g;

              for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
            
                const row = {};
                let values = lines[i].match(regex);
                if (values) {
                    values = values.map(v => {
                        let value = v.startsWith(',') ? v.substring(1) : v;
                        if (value.startsWith('"') && value.endsWith('"')) {
                            value = value.substring(1, value.length - 1).replace(/""/g, '"');
                        }
                        return value.trim();
                    });
            
                    for (let j = 0; j < headers.length; j++) {
                        const value = values[j] || '';
                        const num = parseFloat(value);
                        row[headers[j]] = isNaN(num) || value === '' ? value : num;
                    }
                    data.push(row);
                }
              }
              return { headers, data };
            }

            const parsed = parseCsv(text);
            headers = parsed.headers;
            parsedData = parsed.data;

            const xSelector = document.getElementById('x-column-selector');
            const ySelector = document.getElementById('y-column-selector');
            xSelector.innerHTML = '';
            ySelector.innerHTML = '';
            headers.forEach(header => {
              const optionX = document.createElement('option');
              optionX.value = header;
              optionX.textContent = header;
              xSelector.appendChild(optionX);

              const optionY = document.createElement('option');
              optionY.value = header;
              optionY.textContent = header;
              ySelector.appendChild(optionY);
            });
            importModal.style.display = 'block';
          };
          reader.readAsText(file);
        });

        document.getElementById('import-button').addEventListener('click', () => {
          const xField = document.getElementById('x-column-selector').value;
          const yField = document.getElementById('y-column-selector').value;

          // This is a simplified data loading process.
          // A real implementation would need to handle data tiling for performance.
          // For now, we'll create a single, large tile.
          const plot = window.plot;
          if (plot && parsedData) {
            // @ts-ignore
            plot.loadData(parsedData, xField, yField);
          }

          importModal.style.display = 'none';
        });
      });
    </script>
    <div id="import-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Import Data</h2>
          <span class="close-button">&times;</span>
        </div>
        <div class="modal-body">
          <div class="chart-controls">
            <label for="x-column-selector">X Column:</label>
            <select id="x-column-selector"></select>
          </div>
          <div class="chart-controls">
            <label for="y-column-selector">Y Column:</label>
            <select id="y-column-selector"></select>
          </div>
          <button id="import-button">Import</button>
        </div>
      </div>
    </div>
  </body>
</html>
